C51 COMPILER V9.54   CH395                                                                 07/19/2020 05:38:08 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE CH395
OBJECT MODULE PLACED IN CH395.OBJ
COMPILER INVOKED BY: E:\MDK5\Keil_v5\C51\BIN\C51.EXE CH395.C LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          /********************************** (C) COPYRIGHT *********************************
   2          * File Name          : CH395.C
   3          * Author             : WCH
   4          * Version            : V1.1
   5          * Date               : 2014/8/1
   6          * Description        : CH395¹¦ÄÜÑÝÊ¾
   7          **********************************************************************************/
   8          
   9          /**********************************************************************************
  10          CH395 TCP/IP Ð­Òé×å½Ó¿Ú
  11          MSC51 ÑÝÊ¾³ÌÐò£¬ÓÃÓÚÑÝÊ¾Socket0¹¤×÷ÔÚMAC RAWÄ£Ê½ÏÂ£¬µ¥Æ¬»úÊÕµ½Êý¾Ýºó£¬Ö±½Ó
  12          ÉÏ´«¡£MCS51@24MHZ,KEIL 4
  13          **********************************************************************************/
  14          /* Í·ÎÄ¼þ°üº¬*/
  15          #include <reg52.h>
  16          #include "stdio.h"
  17          #include "string.h"
  18          #include "../PUB/CH395INC.H"
  19          #include "CH395.H"
  20          
  21          /**********************************************************************************
  22          /*
  23          CH395_OP_INTERFACE_MODE¿ÉÒÔÎª1-5
  24          1£ºÓ²¼þ×ÜÏß²¢¿ÚÁ¬½Ó·½Ê½
  25          2£ºÈí¼þÄ£Äâ²¢¿ÚÁ¬½Ó·½Ê½
  26          3: Ó²¼þSPIÁ¬½Ó·½Ê½
  27          4: Èí¼þÄ£ÄâSPI·½Ê½
  28          5: Ó²¼þÒì²½´®¿ÚÁ¬½Ó·½Ê½
  29          */
  30          #define   CH395_OP_INTERFACE_MODE             3                      
  31          #if   (CH395_OP_INTERFACE_MODE == 1)                                 /* SEL = 0, TX = 1*/
              #include "../PUB/CH395PARA_HW.C"                                           
              #elif (CH395_OP_INTERFACE_MODE == 2)                                 /* SEL = 0, TX = 1*/
              #include "../PUB/CH395PARA_SW.C"                                            
              #elif (CH395_OP_INTERFACE_MODE == 3)                                 /* SEL = 1, TX = 0*/
  36          #include "../PUB/CH395SPI_HW.C"
  37          #elif (CH395_OP_INTERFACE_MODE == 4)                                 /* SEL = 1, TX = 0*/
              #include "../PUB/CH395SPI_SW.C"
              #elif (CH395_OP_INTERFACE_MODE == 5)                                 /* SEL = 1, TX = 1*/
              #include "../PUB/CH395UART.C"
              #else
              #error "Please Select Correct Communication Interface "
              #endif
  44          
  45          /**********************************************************************************/
  46          /* °üº¬ÃüÁîÎÄ¼þ */
  47          #include "../PUB/CH395CMD.C"
  48          /* ³£ÓÃ±äÁ¿¶¨Òå */
  49          UINT8 xdata MyBuffer[512];
  50          struct _SOCK_INF  xdata  SockInf;
  51          struct _CH395_SYS xdata  CH395Inf;
  52          /* CH395Ïà¹Ø¶¨Òå */
  53          const UINT8 CH395MACAddr[6] = {0x02,0x03,0x04,0x05,0x06,0x07};       /* CH395MACµØÖ· */
  54          /*×¢£ºCH395³ö³§Ê±ÒÑÉÕÂ¼MACµØÖ·£¬´Ë´¦ÉèÖÃMACµØÖ·Ö÷ÒªÎªÑÝÊ¾²Ù×÷£¬½¨ÒéÕý³£Ê¹ÓÃÊ±ºò£¬Ö±½Óµ÷ÓÃ»ñÈ¡MACµØÖ·ÃüÁî£¬
             -ÎÞÐèÖØÐÂÉèÖÃMACµØÖ·*/
C51 COMPILER V9.54   CH395                                                                 07/19/2020 05:38:08 PAGE 2   

  55          
  56          #define  CH395_DEBUG                     0
  57          /**********************************************************************************
  58          * Function Name  : mStopIfError
  59          * Description    : µ÷ÊÔÊ¹ÓÃ£¬ÏÔÊ¾´íÎó´úÂë£¬²¢Í£»ú
  60          * Input          : None
  61          * Output         : None
  62          * Return         : None
  63          **********************************************************************************/
  64          void mStopIfError(UINT8 iError)
  65          {
  66   1          if (iError == CMD_ERR_SUCCESS) return;                           /* ²Ù×÷³É¹¦ */
  67   1      #if  CH395_DEBUG
                  printf("Error: %02X\n", (UINT16)iError);                         /* ÏÔÊ¾´íÎó */
              #endif
  70   1          while ( 1 ) 
  71   1          {
  72   2              mDelaymS(200);
  73   2              mDelaymS(200);
  74   2          }
  75   1      }
  76          
  77          /*********************************************************************************
  78          * Function Name  : InitCH395InfParam
  79          * Description    : ³õÊ¼»¯CH395Inf²ÎÊý
  80          * Input          : None
  81          * Output         : None
  82          * Return         : None
  83          **********************************************************************************/
  84          void InitCH395InfParam(void)
  85          {
  86   1          memset(&CH395Inf,0,sizeof(CH395Inf));                            /* ½«CH395InfÈ«²¿ÇåÁã*/
  87   1          memcpy(CH395Inf.MacAddr,CH395MACAddr,sizeof(CH395MACAddr));      /* MACµØÖ· */
  88   1      }
  89          
  90          /**********************************************************************************
  91          * Function Name  : InitSocketParam
  92          * Description    : ³õÊ¼»¯socket
  93          * Input          : None
  94          * Output         : None
  95          * Return         : None
  96          **********************************************************************************/
  97          void InitSocketParam(void)
  98          {
  99   1          memset(&SockInf,0,sizeof(SockInf));                              /* ½«SockInf[0]È«²¿ÇåÁã*/
 100   1          SockInf.ProtoType = PROTO_TYPE_MAC_RAW;                          /* MAC RAWÄ£Ê½ */
 101   1      }
 102          
 103          /**********************************************************************************
 104          * Function Name  : CH395SocketInitOpen
 105          * Description    : ÅäÖÃCH395 socket ²ÎÊý£¬³õÊ¼»¯²¢´ò¿ªsocket
 106          * Input          : None
 107          * Output         : None
 108          * Return         : None
 109          **********************************************************************************/
 110          void CH395SocketInitOpen(void)
 111          {
 112   1          UINT8 i;
 113   1           /* socket 0ÎªMAC RAWÄ£Ê½ */
 114   1          CH395SetSocketProtType(0,SockInf.ProtoType);                     /* ÉèÖÃsocket 0Ð­ÒéÀàÐÍ */
 115   1          i = CH395OpenSocket(0);                                          /* ´ò¿ªsocket 0 */
 116   1          mStopIfError(i);                                                 /* ¼ì²éÊÇ·ñ³É¹¦ */
C51 COMPILER V9.54   CH395                                                                 07/19/2020 05:38:08 PAGE 3   

 117   1      }
 118          
 119          /**********************************************************************************
 120          * Function Name  : CH395SocketInterrupt
 121          * Description    : CH395 socket ÖÐ¶Ï,ÔÚÈ«¾ÖÖÐ¶ÏÖÐ±»µ÷ÓÃ
 122          * Input          : sockindex
 123          * Output         : None
 124          * Return         : None
 125          **********************************************************************************/
 126          void CH395SocketInterrupt(UINT8 sockindex)
 127          {
 128   1         UINT8  sock_int_socket,tmp1[6],tmp2[6],i;
 129   1         UINT16 len;
 130   1      
 131   1         sock_int_socket = CH395GetSocketInt(sockindex);                   /* »ñÈ¡socket µÄÖÐ¶Ï×´Ì¬ */
 132   1         if(sock_int_socket & SINT_STAT_SENBUF_FREE)                       /* ·¢ËÍ»º³åÇø¿ÕÏÐ£¬¿ÉÒÔ¼ÌÐøÐ´ÈëÒª·¢ËÍ
             -µÄÊý¾Ý */
 133   1         {
 134   2         }
 135   1         if(sock_int_socket & SINT_STAT_SEND_OK)                           /* ·¢ËÍÍê³ÉÖÐ¶Ï */
 136   1         {
 137   2         }
 138   1         if(sock_int_socket & SINT_STAT_RECV)                              /* ½ÓÊÕÖÐ¶Ï */
 139   1         {
 140   2          len = CH395GetRecvLength(sockindex);                             /* »ñÈ¡µ±Ç°»º³åÇøÄÚÊý¾Ý³¤¶È */
 141   2      #if CH395_DEBUG
                  printf("receive len = %d\n",len);
              #endif
 144   2          if(len == 0)return;
 145   2          if(len > 512) len = 512;                                         /*MyBuffer»º³åÇø³¤¶ÈÎª512£¬*/
 146   2          CH395GetRecvData(sockindex,len,MyBuffer);                        /* ¶ÁÈ¡Êý¾Ý */
 147   2          for(i=0;i<6;i++)                                                 /*½ÓÊÕµ½µÄÇ°12×Ö½ÚÊý¾ÝÎ»Ä¿µÄMacµØÖ·ºÍ
             -Ô´MacµØÖ·£¬½»»»Î»ÖÃ½øÐÐ×ª·¢*/
 148   2          {
 149   3            tmp1[i] =  MyBuffer[i];
 150   3          }
 151   2          for(i=0;i<6;i++)
 152   2          {
 153   3            tmp2[i] =  MyBuffer[i+6];
 154   3          }
 155   2          for(i=0;i<6;i++)
 156   2          {
 157   3            MyBuffer[i] =  tmp2[i];
 158   3          }
 159   2          for(i=0;i<6;i++)
 160   2          {
 161   3            MyBuffer[i+6] =  tmp1[i];
 162   3          }
 163   2      
 164   2          CH395SendData(sockindex,MyBuffer,len);
 165   2         }
 166   1         if(sock_int_socket & SINT_STAT_CONNECT)                           /* Á¬½ÓÖÐ¶Ï£¬½öÔÚTCPÄ£Ê½ÏÂÓÐÐ§*/
 167   1         {
 168   2             
 169   2         }
 170   1         if(sock_int_socket & SINT_STAT_DISCONNECT)                        /* ¶Ï¿ªÖÐ¶Ï£¬½öÔÚTCPÄ£Ê½ÏÂÓÐÐ§ */
 171   1         {
 172   2         }
 173   1         if(sock_int_socket & SINT_STAT_TIM_OUT)                           /* ³¬Ê±ÖÐ¶Ï£¬½öÔÚTCPÄ£Ê½ÏÂÓÐÐ§ */
 174   1         {
 175   2         }
 176   1      }
C51 COMPILER V9.54   CH395                                                                 07/19/2020 05:38:08 PAGE 4   

 177          
 178          /**********************************************************************************
 179          * Function Name  : CH395GlobalInterrupt
 180          * Description    : CH395È«¾ÖÖÐ¶Ïº¯Êý
 181          * Input          : None
 182          * Output         : None
 183          * Return         : None
 184          **********************************************************************************/
 185          void CH395GlobalInterrupt(void)
 186          {
 187   1         UINT16  init_status;
 188   1         UINT8 xdata buf[64]; 
 189   1       
 190   1          init_status = CH395CMDGetGlobIntStatus_ALL();
 191   1          if(init_status & GINT_STAT_UNREACH)                              /* ²»¿É´ïÖÐ¶Ï£¬¶ÁÈ¡²»¿É´ïÐÅÏ¢ */
 192   1          {
 193   2              CH395CMDGetUnreachIPPT(buf);                                
 194   2          }
 195   1          if(init_status & GINT_STAT_IP_CONFLI)                            /* ²úÉúIP³åÍ»ÖÐ¶Ï£¬½¨ÒéÖØÐÂÐÞ¸ÄCH395µ
             -Ä IP£¬²¢³õÊ¼»¯CH395*/
 196   1          {
 197   2          }
 198   1          if(init_status & GINT_STAT_PHY_CHANGE)                           /* ²úÉúPHY¸Ä±äÖÐ¶Ï*/
 199   1          {
 200   2      #if CH395_DEBUG
                      printf("Init status : GINT_STAT_PHY_CHANGE\n");
              #endif
 203   2          }
 204   1          if(init_status & GINT_STAT_SOCK0)
 205   1          {
 206   2              CH395SocketInterrupt(0);                                     /* ´¦Àísocket 0ÖÐ¶Ï*/
 207   2          }
 208   1          if(init_status & GINT_STAT_SOCK1)
 209   1          {
 210   2              CH395SocketInterrupt(1);                                     /* ´¦Àísocket 1ÖÐ¶Ï*/
 211   2          }
 212   1          if(init_status & GINT_STAT_SOCK2)
 213   1          {
 214   2              CH395SocketInterrupt(2);                                     /* ´¦Àísocket 2ÖÐ¶Ï*/
 215   2          }
 216   1          if(init_status & GINT_STAT_SOCK3)
 217   1          {
 218   2              CH395SocketInterrupt(3);                                     /* ´¦Àísocket 3ÖÐ¶Ï*/       
 219   2          }
 220   1          if(init_status & GINT_STAT_SOCK4)
 221   1          {
 222   2              CH395SocketInterrupt(4);                                     /* ´¦Àísocket 4ÖÐ¶Ï*/
 223   2          }
 224   1          if(init_status & GINT_STAT_SOCK5)                                
 225   1          {
 226   2              CH395SocketInterrupt(5);                                     /* ´¦Àísocket 5ÖÐ¶Ï*/
 227   2          }
 228   1          if(init_status & GINT_STAT_SOCK6)                                
 229   1          {
 230   2              CH395SocketInterrupt(6);                                     /* ´¦Àísocket 6ÖÐ¶Ï*/
 231   2          }
 232   1          if(init_status & GINT_STAT_SOCK7)                                
 233   1          {
 234   2              CH395SocketInterrupt(7);                                     /* ´¦Àísocket 7ÖÐ¶Ï*/
 235   2          }
 236   1      }
 237          
C51 COMPILER V9.54   CH395                                                                 07/19/2020 05:38:08 PAGE 5   

 238          /**********************************************************************************
 239          * Function Name  : CH395Init
 240          * Description    : ÅäÖÃCH395µÄIP,GWIP,MACµÈ²ÎÊý£¬²¢³õÊ¼»¯
 241          * Input          : None
 242          * Output         : None
 243          * Return         : º¯ÊýÖ´ÐÐ½á¹û
 244          **********************************************************************************/
 245          UINT8  CH395Init(void)
 246          {
 247   1          UINT8 i;
 248   1          
 249   1          i = CH395CMDCheckExist(0x65);                      
 250   1          if(i != 0x9a)return CH395_ERR_UNKNOW;                            /* ²âÊÔÃüÁî£¬Èç¹ûÎÞ·¨Í¨¹ý·µ»Ø0XFA */
 251   1                                                                           /* ·µ»Ø0XFAÒ»°ãÎªÓ²¼þ´íÎó»òÕß¶ÁÐ´Ê±Ðò
             -²»¶Ô */
 252   1      #if (CH395_OP_INTERFACE_MODE == 5)                                   
              #ifdef UART_WORK_BAUDRATE
                  CH395CMDSetUartBaudRate(UART_WORK_BAUDRATE);                     /* ÉèÖÃ²¨ÌØÂÊ */   
                  mDelaymS(1);
                  SetMCUBaudRate();
              #endif
              #endif
 259   1      
 260   1          CH395CMDSetMACAddr(CH395Inf.MacAddr);                            /* ÉèÖÃCH395µÄMACµØÖ·£¬MAC RAW½öÐèÒªÉ
             -èÖÃMACµØÖ· */
 261   1          mDelaymS(200);                                                   /*±ØÒªµÄÑÓÊ±º¯Êý*/
 262   1          mDelaymS(200);    
 263   1          mDelaymS(200);    
 264   1          mDelaymS(200);    
 265   1          mDelaymS(200);    
 266   1          mDelaymS(200);    
 267   1          mDelaymS(200);    
 268   1          mDelaymS(200);    
 269   1          mDelaymS(200);    
 270   1          i = CH395CMDInitCH395();                                         /* ³õÊ¼»¯CH395Ð¾Æ¬ */
 271   1          return i;
 272   1      }
 273          
 274          /**********************************************************************************
 275          * Function Name  : mInitSTDIO
 276          * Description    : ´®¿Ú³õÊ¼»¯,½öµ÷ÊÔÊ¹ÓÃ
 277          * Input          : None
 278          * Output         : None
 279          * Return         : None
 280          **********************************************************************************/
 281          void mInitSTDIO( void )
 282          {
 283   1          SCON = 0x50;
 284   1          PCON = 0x80;
 285   1          TMOD = 0x21;
 286   1          TH1 = 0xf3;                                                      /* 24MHz¾§Õñ, 9600bps */
 287   1          TR1 = 1;
 288   1          TI = 1;
 289   1      }
 290          
 291          /**********************************************************************************
 292          * Function Name  : main
 293          * Description    : mainÖ÷º¯Êý
 294          * Input          : None
 295          * Output         : None
 296          * Return         : None
 297          **********************************************************************************/
C51 COMPILER V9.54   CH395                                                                 07/19/2020 05:38:08 PAGE 6   

 298          int main(void)
 299          {
 300   1          UINT8 i;
 301   1       
 302   1          mDelaymS(100);                                                   /* ÑÓÊ±100ºÁÃë */
 303   1          mInitSTDIO();
 304   1      #if CH395_DEBUG
                  printf("CH395EVT Test Demo\n");
              #endif
 307   1          CH395_PORT_INIT();
 308   1          InitCH395InfParam();                                             /* ³õÊ¼»¯CH395Ïà¹Ø±äÁ¿ */
 309   1          i = CH395Init();                                                 /* ³õÊ¼»¯CH395Ð¾Æ¬ */
 310   1          mStopIfError(i);
 311   1                                                                           
 312   1         while(1)
 313   1         {                                                                 /* µÈ´ýÒÔÌ«ÍøÁ¬½Ó³É¹¦*/
 314   2             if(CH395CMDGetPHYStatus() == PHY_DISCONN)                     /* ²éÑ¯CH395ÊÇ·ñÁ¬½Ó */
 315   2             {
 316   3                 mDelaymS(200);                                            /* Î´Á¬½ÓÔòµÈ´ý200MSºóÔÙ´Î²éÑ¯ */
 317   3             }
 318   2             else 
 319   2             {
 320   3      #if CH395_DEBUG
                         printf("CH395 Connect Ethernet\n");                       /* CH395Ð¾Æ¬Á¬½Óµ½ÒÔÌ«Íø£¬´ËÊ±»á²úÉúÖ
             -Ð¶Ï */
              #endif
 323   3                 break;
 324   3             }
 325   2         }
 326   1         InitSocketParam();                                                /* ³õÊ¼»¯socketÏà¹Ø±äÁ¿ */
 327   1         CH395SocketInitOpen();
 328   1         while(1)
 329   1         {
 330   2             if(CH395_INT_WIRE == 0)CH395GlobalInterrupt();                /* ÖÐ¶Ï´¦Àíº¯Êý */
 331   2         }
 332   1      }
 333          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2919    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =    581     183
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
